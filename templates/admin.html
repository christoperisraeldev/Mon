{% extends "base.html" %}
{% block content %}
<h2>Admin - Manage Knowledgebase Files</h2>

<div style="margin-bottom: 1.25rem;">
  <input type="file" id="file-upload" aria-label="Upload knowledgebase file" />
  <button id="upload-file-btn" aria-label="Upload file">Upload File</button>
</div>

<h3>Uploaded Files:</h3>
<ul id="files-list" aria-live="polite" aria-atomic="false"></ul>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const fileUpload = document.getElementById("file-upload");
  const uploadBtn = document.getElementById("upload-file-btn");
  const filesList = document.getElementById("files-list");

  async function fetchFiles() {
    try {
      const res = await fetch("/api/files");
      const data = await res.json();
      filesList.innerHTML = "";
      data.files.forEach((file) => {
        const li = document.createElement("li");
        li.textContent = file;
        const delBtn = document.createElement("button");
        delBtn.textContent = "Delete";
        delBtn.setAttribute("aria-label", "Delete " + file);
        delBtn.addEventListener("click", () => deleteFile(file));
        li.appendChild(delBtn);
        filesList.appendChild(li);
      });
    } catch {
      filesList.innerHTML = '<span style="color:red;">Failed to load files.</span>';
    }
  }

  async function deleteFile(filename) {
    if (!confirm(`Delete file "${filename}"?`)) return;
    try {
      const res = await fetch("/api/delete_file", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ filename }),
      });
      const data = await res.json();
      if (data.success) {
        alert("File deleted.");
        fetchFiles();
      } else {
        alert(data.error || "Error deleting file.");
      }
    } catch {
      alert("Delete request failed.");
    }
  }

  uploadBtn.addEventListener("click", async () => {
    if (!fileUpload.files.length) {
      alert("Please select a file to upload.");
      return;
    }
    const file = fileUpload.files[0];
    const formData = new FormData();
    formData.append("file", file);
    try {
      const res = await fetch("/api/upload", {
        method: "POST",
        body: formData,
      });
      const data = await res.json();
      if (data.success) {
        alert("File uploaded.");
        fileUpload.value = "";
        fetchFiles();
      } else {
        alert(data.error || "File upload failed.");
      }
    } catch {
      alert("File upload failed.");
    }
  });

  fetchFiles();
});
</script>
{% endblock %}
