{% extends "base.html" %}
{% block content %}
<div id="chat-window" class="chat-window" aria-live="polite" aria-atomic="false" style="height: 70vh; overflow-y: auto; padding: 1rem; border: 1px solid #cbd5e1; border-radius: 8px; background-color: #f9fafb;"></div>

<div class="chat-input-container" role="form" aria-label="Chat message input" style="margin-top: 1rem; display: flex; gap: 1rem;">
  <textarea id="chat-input" placeholder="Ask your medical questions here…" aria-label="Chat input" autocomplete="off" spellcheck="true"></textarea>
  <button id="send-btn" aria-label="Send message" type="button" class="chat-button">Send</button>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const chatWindow = document.getElementById("chat-window");
  const chatInput = document.getElementById("chat-input");
  const sendBtn = document.getElementById("send-btn");

  // Auto-resize chat input textarea
  chatInput.style.height = "36px";
  chatInput.style.overflowY = "hidden";

  chatInput.addEventListener("input", () => {
    chatInput.style.height = "36px"; // reset height
    chatInput.style.height = Math.min(chatInput.scrollHeight, 140) + "px";
    chatInput.style.overflowY = chatInput.scrollHeight > 140 ? "auto" : "hidden";
  });

  function appendMessage(sender, text, isHtml = false) {
    const div = document.createElement("div");
    div.classList.add(sender === "AI" ? "ai-message" : "user-message");
    if (isHtml) {
      div.innerHTML = text;
    } else {
      div.textContent = text;
    }
    chatWindow.appendChild(div);
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }

  function markdownToHtml(md) {
    let html = md
      .replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
      // Headers
      .replace(/^### (.*)$/gm, "<h3>$1</h3>")
      .replace(/^## (.*)$/gm, "<h2>$1</h2>")
      .replace(/^# (.*)$/gm, "<h1>$1</h1>")
      // Bold & Italic
      .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
      .replace(/\*(.*?)\*/g, "<em>$1</em>")
      // Unordered Lists
      .replace(/^\s*-\s+(.*)$/gm, "<li>$1</li>")
      .replace(/(<li>.*<\/li>)/gs, "<ul>$1</ul>")
      // Ordered Lists
      .replace(/^\s*\d+\.\s+(.*)$/gm, "<li>$1</li>")
      .replace(/(<li>.*<\/li>)/gs, "<ol>$1</ol>")
      // Tables: markdown pipe tables to HTML tables
      .replace(/((\|.*\|\s*\n)+)/gm, (match) => {
        const lines = match.trim().split(/\r?\n/);
        if (lines.length < 2) return match;

        const headerLine = lines[0];
        const separatorLine = lines[1];
        if (!/^\|?(\s*:?-+:?\s*\|)+\s*$/.test(separatorLine)) return match;

        const headers = headerLine.trim().split('|').filter(h => h.trim() !== '');
        const rows = lines.slice(2).map(line => line.trim().split('|').filter(c => c.trim() !== ''));

        let tableHtml = "<table><thead><tr>";
        headers.forEach(h => tableHtml += `<th>${h.trim()}</th>`);
        tableHtml += "</tr></thead><tbody>";
        rows.forEach(r => {
          tableHtml += "<tr>";
          r.forEach(c => tableHtml += `<td>${c.trim()}</td>`);
          tableHtml += "</tr>";
        });
        tableHtml += "</tbody></table>";
        return tableHtml;
      })
      // Paragraph breaks
      .replace(/\n{2,}/g, "<br><br>")
      // Line breaks inside paragraphs
      .replace(/\n/g, "<br>")
      // Links
      .replace(/\[([^\[]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
    return html;
  }

  sendBtn.addEventListener("click", async () => {
    const message = chatInput.value.trim();
    if (!message) {
      alert("Please enter a message.");
      return;
    }

    appendMessage("User", message);
    chatInput.value = "";
    chatInput.style.height = "36px";

    appendMessage("AI", "Thinking…");

    try {
      const response = await fetch("/api/chat", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({message})
      });
      const data = await response.json();

      // Remove last 'Thinking...'
      const aiMessages = chatWindow.querySelectorAll(".ai-message");
      if (aiMessages.length) aiMessages[aiMessages.length - 1].remove();

      // Parse markdown to rich html
      appendMessage("AI", markdownToHtml(data.response), true);

    } catch (err) {
      const aiMessages = chatWindow.querySelectorAll(".ai-message");
      if (aiMessages.length) aiMessages[aiMessages.length - 1].remove();

      appendMessage("AI", "Error communicating with server.");
    }
  });

  // Send on Ctrl+Enter
  chatInput.addEventListener("keydown", (e) => {
    if (e.ctrlKey && e.key === "Enter") {
      sendBtn.click();
    }
  });
});
</script>
{% endblock %}
